#include <lpc21xx.h>
// all rows and columns are connect in P1 port 

#include "lcd_4x4.h"

#define C0 (IOPIN1& (1<<20)) //column 0-3 -->totally (4)columns
#define C1 (IOPIN1& (1<<21))
#define C2 (IOPIN1& (1<<22))
#define C3 (IOPIN1& (1<<23))

#define r0  1<<16 //Row 0-3 --> (4)rows
#define r1  1<<17
#define r2  1<<18
#define r3  1<<19


unsigned int key_lut[4][4]={{1,2,3,4},{5,6,7,8},{9,10,11,12},{13,14,15,16}};

unsigned int keyscan(void)
{
  unsigned char row_val,col_val;
	PINSEL2|=0X00000000;
	IODIR1|=r0|r1|r2|r3; // default value of rows are 0 so directions as output
	
	while(1)	// inner while loop start to find which row is pressed 
	{
     IOCLR1|= r0|r1|r2|r3;
     IOSET1|=C0|C1|C2|C3;
		while((C0&&C1&&C2&&C3)==1);// wait till for the  key is pressed
 
		// testing the row 0
		IOCLR1|=r0;
		IOSET1|=r1|r2|r3;
		if((C0&&C1&&C2&&C3)==0)
			{
				row_val=0;
				break;
      }
			
			
			
		// testing the row 1
		IOCLR1|=r1;
		IOSET1|=r0|r2|r3;
		if((C0&&C1&&C2&&C3)==0)
			{
				row_val=1;
				break;
      }
		

			
			
		// testing the row 2
		IOCLR1|=r2;
		IOSET1|=r0|r1|r3;
		if((C0&&C1&&C2&&C3)==0)
			{
				row_val=2;
				break;
      }
			
			
			
			
			
		// testing the row 3
		IOCLR1|=r3;
		IOSET1|=r0|r1|r2;
		if((C0&&C1&&C2&&C3)==0)
			{
				row_val=3;
				break;
      }
  
	
	
}// inner loop ends for checking the row


if(C0==0)
	col_val=0;
else if(C1==0)
	col_val=1;
else if(C2==0)
	col_val=2;
else
	col_val=3;


delay_ms(200);// due to switch bouncing waut here for 200ms

while((C0&&C1&&C2&&C3)==0);// wait till for the  key to release

return key_lut[row_val][col_val];

}

int main()
{
  int res;
	LCD_INITI();
	LCD_str("4x4 keypad");
	while(1)
	{
	  LCD_COMMAND(0X80);
		//LCD_str("4x4 keypad");
		LCD_COMMAND(0xc0);
		res=keyscan();
		LCD_DATA((res/10)+48);
		LCD_DATA((res%10)+48);
		//LCD_int(res);
		delay_ms(2000);
		LCD_COMMAND(0x01);
		
	}

}





